name: CI
on:
  push:
    branches: [main, master]
  repository_dispatch:
    types: [rebuild]
  workflow_dispatch: {}

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Configure git for private repos
        run: git config --global url."https://x-access-token:${{ secrets.PRIVATE_DEPS_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Create .env from secrets
        env:
          ALL_SECRETS: ${{ toJSON(secrets) }}
        run: |
          python3 -c "
          import json, os
          secrets = json.loads(os.environ['ALL_SECRETS'])
          with open('.env', 'w') as f:
              for k, v in secrets.items():
                  if k.startswith('GITHUB_'):
                      continue
                  f.write(f'{k}={v}\n')
          print(f'Wrote {len(secrets)} env vars to .env')
          "

      - name: Start MCP server
        env:
          MIDDLEWARE_CLIENT_ID: ${{ github.event.repository.name }}
          MIDDLEWARE_AUTH_SECRET: ${{ secrets.MIDDLEWARE_AUTH_SECRET }}
          ENCLAVE_URL: ${{ secrets.ENCLAVE_URL }}
        run: |
          uv run uvicorn app:app --port 8000 --host 0.0.0.0 &
          for i in $(seq 1 30); do
            curl -sf http://localhost:8000/health && echo " Server ready" && break
            sleep 1
          done

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Test MCP server
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          JSON_SCHEMA='{"type":"object","properties":{"all_passed":{"type":"boolean"},"report":{"type":"string"}},"required":["all_passed","report"]}'
          timeout --signal=TERM --kill-after=30s 1200 \
            claude -p --dangerously-skip-permissions --model claude-haiku-4-5 --max-turns 50 --max-budget-usd 1 \
              --output-format json --json-schema "$JSON_SCHEMA" "
            Test the MCP server at http://localhost:8000/mcp. Be concise.

            1. Read server.py to find all @mcp.tool definitions and which have cutoff_date params
            2. Write and run a Python script that:
               - Connects: from fastmcp import Client; from fastmcp.client.transports import StreamableHttpTransport; client = Client(StreamableHttpTransport(url='http://localhost:8000/mcp'))
               - Lists tools and prints count
               - Calls each tool with simple valid inputs, verifies non-empty response
               - For tools with cutoff_date: picks a random date 1-5 months ago, calls with that cutoff_date, and checks response has no info from after that date
            3. Print summary: tool name, PASS/FAIL, reason for failures

            Set all_passed=true only if every tool passed. Put the full test report in report.
            " > /tmp/claude-result.json 2>/tmp/claude-stderr.txt
          echo "Raw output:"
          cat /tmp/claude-result.json

      - name: Check test results
        run: |
          if [ ! -s /tmp/claude-result.json ]; then
            echo "No output from Claude Code"
            [ -f /tmp/claude-stderr.txt ] && cat /tmp/claude-stderr.txt
            exit 1
          fi
          python3 -c "
          import json, sys
          with open('/tmp/claude-result.json') as f:
              raw = json.load(f)
          data = raw.get('structured_output') or raw.get('result') or raw
          if isinstance(data, str):
              data = json.loads(data)
          print(data['report'])
          with open('/tmp/claude-summary.txt', 'w') as f:
              f.write(data['report'][:2800])
          if not data['all_passed']:
              sys.exit(1)
          "

      - name: Notify failure via Slack
        if: failure() || cancelled()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then exit 0; fi
          REPO="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ -f /tmp/claude-summary.txt ]; then
            SUMMARY=$(cat /tmp/claude-summary.txt)
          elif [ -f /tmp/claude-stderr.txt ]; then
            SUMMARY=$(tail -20 /tmp/claude-stderr.txt | head -c 2800)
          else
            SUMMARY="No test output (server may have failed to start)"
          fi
          SUMMARY_JSON=$(python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))" <<< "$SUMMARY")
          curl -sf "$SLACK_WEBHOOK_URL" -H 'Content-Type: application/json' \
            -d "$(python3 -c "
          import json
          blocks = [
            {'type':'header','text':{'type':'plain_text','text':'CI Failed'}},
            {'type':'section','fields':[
              {'type':'mrkdwn','text':'*Repo:*\n$REPO'},
              {'type':'mrkdwn','text':'*Summary:*\n' + json.loads($SUMMARY_JSON)[:2800]}
            ]},
            {'type':'section','text':{'type':'mrkdwn','text':'*Run:* <$RUN_URL|View logs>'}}
          ]
          print(json.dumps({'text':'CI failed for $REPO','blocks':blocks}))
          ")"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/chestnutforty/${{ github.event.repository.name }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-
      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            GITHUB_TOKEN=${{ secrets.PRIVATE_DEPS_TOKEN }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
