name: CI
on:
  push:
    branches: [main, master]
  repository_dispatch:
    types: [rebuild]
  workflow_dispatch: {}

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Configure git for private repos
        run: git config --global url."https://x-access-token:${{ secrets.PRIVATE_DEPS_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Create .env from secrets
        env:
          ALL_SECRETS: ${{ toJSON(secrets) }}
        run: |
          python3 -c "
          import json, os
          secrets = json.loads(os.environ['ALL_SECRETS'])
          with open('.env', 'w') as f:
              for k, v in secrets.items():
                  if k.startswith('GITHUB_'):
                      continue
                  f.write(f'{k}={v}\n')
          print(f'Wrote {len(secrets)} env vars to .env')
          "

      - name: Start MCP server
        env:
          MIDDLEWARE_CLIENT_ID: ${{ github.event.repository.name }}
        run: |
          uv run uvicorn app:app --port 8000 --host 0.0.0.0 &
          for i in $(seq 1 30); do
            curl -sf http://localhost:8000/health && echo " Server ready" && break
            sleep 1
          done

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Test MCP server
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set +e
          timeout --signal=TERM --kill-after=30s 1200 \
            claude -p --dangerously-skip-permissions --model claude-haiku-4-5 --max-turns 50 --max-budget-usd 1 "
            Test the MCP server at http://localhost:8000/mcp. Be concise.

            1. Read server.py to find all @mcp.tool definitions and which have cutoff_date params
            2. Write and run a Python script that:
               - Connects: from fastmcp import Client; from fastmcp.client.transports import StreamableHttpTransport; client = Client(StreamableHttpTransport(url='http://localhost:8000/mcp'))
               - Lists tools and prints count
               - Calls each tool with simple valid inputs, verifies non-empty response
               - For tools with cutoff_date: picks a random date 1-5 months ago, calls with that cutoff_date, and checks response has no info from after that date
            3. Print summary: tool name, PASS/FAIL, reason for failures
            4. If any failures: exit 1
            " 2>&1 | tee /tmp/claude-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -eq 124 ]; then
            echo "CLAUDE_ERROR=Timed out after 20 minutes" >> "$GITHUB_ENV"
            exit 1
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "CLAUDE_ERROR=Exited with code $EXIT_CODE" >> "$GITHUB_ENV"
            exit 1
          fi
          # Fail if Claude hit max turns or budget without completing tests
          if grep -qiE 'Reached max turns|max budget' /tmp/claude-output.txt; then
            echo "CLAUDE_ERROR=Claude ran out of turns/budget before completing tests" >> "$GITHUB_ENV"
            exit 1
          fi

      - name: Notify failure via Slack
        if: failure() || cancelled()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then exit 0; fi
          REPO="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CLAUDE_LOG=""
          if [ -f /tmp/claude-output.txt ]; then
            CLAUDE_LOG=$(tail -80 /tmp/claude-output.txt | head -c 2800)
          fi
          CLAUDE_LOG_JSON=$(python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))" <<< "$CLAUDE_LOG")
          ERROR_MSG="${CLAUDE_ERROR:-Unknown error}"
          curl -sf "$SLACK_WEBHOOK_URL" -H 'Content-Type: application/json' \
            -d "$(python3 -c "
          import json
          blocks = [
            {'type':'header','text':{'type':'plain_text','text':'CI Failed'}},
            {'type':'section','fields':[
              {'type':'mrkdwn','text':'*Repo:*\n$REPO'},
              {'type':'mrkdwn','text':'*Error:*\n$ERROR_MSG'}
            ]},
            {'type':'section','text':{'type':'mrkdwn','text':'*Run:* <$RUN_URL|View logs>'}},
            {'type':'section','text':{'type':'mrkdwn','text':'*Claude output (last 80 lines):*\n\`\`\`' + json.loads($CLAUDE_LOG_JSON)[:2800] + '\`\`\`'}}
          ]
          print(json.dumps({'text':'CI failed for $REPO','blocks':blocks}))
          ")"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/chestnutforty/${{ github.event.repository.name }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-
      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            GITHUB_TOKEN=${{ secrets.PRIVATE_DEPS_TOKEN }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
