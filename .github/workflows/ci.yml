name: CI

on:
  push:
    branches: [main, master]
  workflow_dispatch: {}

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync

      - name: Create .env from secrets
        env:
          ALL_SECRETS: ${{ toJSON(secrets) }}
        run: |
          python3 -c "
          import json, os
          secrets = json.loads(os.environ['ALL_SECRETS'])
          with open('.env', 'w') as f:
              for k, v in secrets.items():
                  if k.startswith('GITHUB_'):
                      continue
                  f.write(f'{k}={v}\n')
          print(f'Wrote {len(secrets)} env vars to .env')
          "

      - name: Verify server loads
        run: |
          uv run python -c "
          from server import mcp
          tools = mcp._tool_manager._tools
          print(f'Server: {mcp.name}')
          print(f'Tools registered: {len(tools)}')
          for name in tools:
              print(f'  - {name}')
          assert len(tools) > 0, 'No tools registered â€” server.py is broken'
          "

      - name: Run tests
        run: uv run pytest tests/ -v

      - name: Notify failure via Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "No SLACK_WEBHOOK_URL set, skipping notification"
            exit 0
          fi
          REPO="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT="${{ github.sha }}"
          SHORT_SHA="${COMMIT:0:7}"
          PUSHER="${{ github.actor }}"
          curl -sf "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"CI failed for ${REPO}\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {\"type\": \"plain_text\", \"text\": \"CI Failed\"}
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Repo:*\n${REPO}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\n${SHORT_SHA}\"}
                  ]
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Pushed by:*\n${PUSHER}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Run:*\n<${RUN_URL}|View logs>\"}
                  ]
                }
              ]
            }" || echo "Slack notification failed"
